{% extends "menu.html" %}

{% block content %}
<div class="container text-center">
    <h1 class="display-4 mt-5">Smart Meter Management System</h1>
    <p class="lead mt-4">Please select an action:</p>
    
    <div class="row mt-4">
        <div class="col-md-3">
            <button class="btn btn-primary w-100" onclick="showSection('registerSection')">ğŸ“ Register Meter</button>
        </div>
        <div class="col-md-3">
            <button class="btn btn-success w-100" onclick="showSection('meterReadingSection')">âš¡ Submit Reading</button>
        </div>
        <div class="col-md-3">
            <button class="btn btn-info w-100" onclick="showSection('dailyUsageSection')">ğŸ“Š Daily Usage</button>
        </div>
        <div class="col-md-3">
            <button class="btn btn-warning w-100" onclick="showSection('monthlyBillSection')">ğŸ’³ Monthly Bill</button>
        </div>
    </div>
    
    <!-- <div class="text-end mt-3">
        <button class="btn btn-danger" onclick="stopServer()">ğŸ›‘ Stop Server</button>
    </div> -->
</div>

<!-- Register Meter -->
<div id="registerSection" class="form-section mt-4" style="display:none;">
    <h2 class="mb-4">ğŸ“ Register New Meter</h2>
    <form id="registerForm">
        <input type="text" class="form-control mb-3" placeholder="Meter ID (123-456-789)" id="meter_id" required>
        <input type="text" class="form-control mb-3" placeholder="Region" id="region" required>
        <input type="text" class="form-control mb-3" placeholder="Dwelling Type" id="dwelling_type" required>
        <button type="submit" class="btn btn-primary w-100">Register</button>
    </form>
    <div id="registerMessage" class="mt-3"></div>
</div>

<!-- Submit Reading -->
<div id="meterReadingSection" class="form-section mt-4" style="display:none;">
    <h2 class="mb-4">âš¡ Submit Meter Reading</h2>
    <form id="readingForm">
        <input type="text" class="form-control mb-3" placeholder="Meter ID" id="reading_meter_id" required>
        <input type="date" class="form-control mb-3" id="date" required>
        <input type="time" class="form-control mb-3" id="time" step="1800" required>
        <input type="number" class="form-control mb-3" placeholder="Reading (kWh)" id="electricity_reading" required>
        <button type="submit" class="btn btn-success w-100">Submit</button>
    </form>
    <div id="readingMessage" class="mt-3"></div>
</div>

<!-- Daily Usage Query -->
<div id="dailyUsageSection" class="form-section mt-4" style="display:none;">
    <h2 class="mb-4">ğŸ“Š Daily Usage Query</h2>
    <input type="text" class="form-control mb-3" placeholder="Meter ID (123-456-789)" id="queryMeterId">
    <button class="btn btn-info w-100" onclick="queryUsage()">Query</button>
    <div id="usageResult" class="mt-3"></div>
</div>

<!-- Monthly Bill Query -->
<div id="monthlyBillSection" class="form-section mt-4" style="display:none;">
    <h2 class="mb-4">ğŸ’³ Monthly Bill Query</h2>
    <input type="text" class="form-control mb-3" placeholder="Meter ID (123-456-789)" id="queryBillMeterId">
    <button class="btn btn-warning w-100" onclick="queryMonthlyBill()">Query</button>
    <div id="billResult" class="mt-3"></div>
</div>

<script>
function showSection(sectionId) {
    document.getElementById("registerSection").style.display = "none";
    document.getElementById("meterReadingSection").style.display = "none";
    document.getElementById("dailyUsageSection").style.display = "none";
    document.getElementById("monthlyBillSection").style.display = "none";
    document.getElementById(sectionId).style.display = "block";
}

// async function stopServer() {
//     try {
//         const response = await fetch('/stop_server', { method: 'POST' });
//         const data = await response.json();
//         alert(data.message);
//     } catch (error) {
//         alert("Failed to stop server");
//     }
// }

async function queryMonthlyBill() {
    const meterId = document.getElementById("queryBillMeterId").value;
    if (!meterId.match(/\d{3}-\d{3}-\d{3}/)) {
        document.getElementById("billResult").innerHTML = `<div class='alert alert-danger'>Please enter a valid Meter ID</div>`;
        return;
    }
    try {
        const response = await fetch(`/meter/monthly/${meterId}`);
        const data = await response.json();
        if (!response.ok) throw new Error(data.message);
        document.getElementById("billResult").innerHTML = `<div class='alert alert-success'>Meter ${data.meter_id} - Total Bill: ${data.total_bill} USD</div>`;
    } catch (error) {
        document.getElementById("billResult").innerHTML = `<div class='alert alert-danger'>${error.message}</div>`;
    }
}
</script>
{% endblock %}
